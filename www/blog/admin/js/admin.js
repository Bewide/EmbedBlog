var a=a||{};a.router={defloc:"/blog/list/",init:function(){window.addEventListener("hashchange",function(e){a.router.parseHash(window.location.hash.substring(1),e.oldURL.split("#")[1])}),a.router.parseHash(window.location.hash.substring(1),"/")},parseHash:function(inp,lasthash){if(inp){var parts=inp.split("/").filter(function(e){return""!=e});void 0!==lasthash&&lasthash.split("/").filter(function(e){return""!=e}),0<parts.length&&"blog"==parts[0]?"list"==parts[1]?a.blog.listPage():"edit"==parts[1]&&a.blog.editPage(parts[2]):window.location.hash=a.router.defloc}else window.location.hash=a.router.defloc}},a.s={loader:{fs:{create:function(){$("body").append('<div id="fsloader"><span><i class="spinner">&#9696;</i></span></div>'),setTimeout(function(){a.s.loader.fs.remove()},8e3)},remove:function(){$("#fsloader").fadeOut(50,function(){$(this).remove()})}}},growl:{create:function(title,txt,o){var duration=o.duration||2e3;document.getElementById("growlc")||$("body").append('<div id="growlc"></div>');var token=a.s.createToken(),c='<div class="notification" id="growl_notif_'+token+'">';c+='<i class="close" data-action="remove_growl_notification" style="font-style:normal;">&times;</i>',c+="<h5>"+title+"</h5>",txt&&(c+="<p>"+txt+"</p>"),c+="</div>",$("#growlc").append(c);var win=$("#growl_notif_"+token);win.fadeIn(200,function(){$('i[data-action="remove_growl_notification"]',win).unbind("click").click(function(){a.s.growl.remove(token)}),setTimeout(function(){a.s.growl.remove(token)},duration)})},remove:function(token){var win=$("#growl_notif_"+token);win.fadeOut(200,function(){win.remove(),0==$("#growlc>div.notification").length&&$("#growlc").remove()})}},popup:{winlist:[],create:function(s){var w=s.width||400,h=s.height||300,title=s.title||"",inpc=s.content||"",show_actions=s.show_actions||!1,actions_content=s.actions_content||"",btntitle=s.btntitle||"",add_cancel=s.add_cancel||!1,f_ready=s.ready||function(){},f_close=s.close||function(){},f_submit=s.submit||function(){},submit_no_loader=s.submit_no_loader||!1,bgcolor=s.bgcolor||"#fff",token=a.s.createToken(),cnt="";cnt+='<div class="popup" id="popupid_'+token+'">',cnt+='<div class="popupwin" style="background-color:'+bgcolor+';">',cnt+='<div class="popupwinbar">',cnt+="<h4>"+title+"</h4>",cnt+="</div>",cnt+='<i class="close">&times;</i>',cnt+='<div class="ic">'+inpc+"</div>",(btntitle||show_actions)&&(cnt+='<div class="actions" style="background-color:#fff;"><div class="row-table-nobr autowidth">',actions_content?cnt+=actions_content:(add_cancel&&(cnt+='<div class="col left"><button class="btn btn-link" data-btn="btn_cancel"><span>Cancel</span></button></div>'),btntitle&&(cnt+='<div class="col right"><button class="btn btn-success" data-btn="btn_submit"><i class="fa fa-spinner fa-spin" style="display:none;"></i><span>'+btntitle+"</span></button></div>")),cnt+="</div></div>"),cnt+="</div>",cnt+="</div>",0==a.s.popup.winlist.length&&($("body").append('<div id="popup_container"></div>'),$("#popup_container").fadeIn(50,function(){})),a.s.popup.winlist.push(token),$("#popup_container .popup").attr("data-active-popup","false"),$("#popup_container").append(cnt);var winw=window.innerWidth,winh=window.innerHeight;winw<w&&(w=winw),winh<h&&(h=winh),winw<=768&&(w=winw,h=winh);var whalf=w/2,ch=h-95,chnobtn=h-45,closebtn=w-41,win_top=winh/2-h/2,pwin=$("#popupid_"+token+" .popupwin");return $(pwin).css("width",w+"px"),$(pwin).css("height",h+"px"),$(pwin).css("left","calc(50% - "+whalf+"px)"),$(pwin).css("top",win_top+"px"),$("i.close",pwin).css("left",closebtn+"px"),btntitle||show_actions?$(".ic",pwin).css("height",ch+"px"):$(".ic",pwin).css("height",chnobtn+"px"),$("#popupid_"+token+" .popupwin").animate({opacity:1},200),a.s.keymng.escList.push({token:token,run:function(){a.s.popup.remove(token,f_close)}}),btntitle&&$("#popupid_"+token+' button[data-btn="btn_submit"]').unbind("click").click(function(){submit_no_loader||a.s.loader.fs.create(),f_submit(function(close_window){void 0===close_window&&(close_window=!0),close_window&&a.s.popup.remove(token,f_close),submit_no_loader||a.s.loader.fs.remove()})}),add_cancel&&$("#popupid_"+token+' button[data-btn="btn_cancel"]').unbind("click").click(function(){a.s.popup.remove(token,f_close)}),$("i.close",pwin).click(function(){a.s.popup.remove(token,f_close)}),f_ready(token),setTimeout(function(){0<$("#popup_container").children().length?0==$("#popup_container").is(":visible")&&$("#popup_container").fadeIn(50,function(){}):(a.s.popup.winlist=[],$("#popup_container").remove())},500),token},remove:function(token,cb_close){$("#popupid_"+token).addClass("remove"),$("#popupid_"+token).fadeOut(100,function(){$("#popupid_"+token).remove(),a.s.keymng.escRemove(token),a.s.popup.winlist.splice(a.s.popup.winlist.indexOf(token),1),0==a.s.popup.winlist.length?$("#popup_container").fadeOut(100,function(){$(this).remove(),cb_close()}):cb_close()})},notify:function(title,msg,timeout){var token=a.s.popup.create({width:300,height:100,title:title,content:'<div class="icontainer space">'+msg+"</div>"});setTimeout(function(){a.s.popup.remove(token,function(){})},timeout)}},keymng:{init:function(){$(document).keydown(function(e){27==e.which&&a.s.keymng.escKey()})},escList:[],escKey:function(){0!==a.s.keymng.escList.length&&a.s.keymng.escList[a.s.keymng.escList.length-1].run()},escRemove:function(token){if(0!==a.s.keymng.escList.length)for(i=0;i<a.s.keymng.escList.length;i++)if(a.s.keymng.escList[i].token==token){a.s.keymng.escList.splice(i,1);break}}},createToken:function(){return Math.random().toString(36).substr(2)}};var tpl={run:function(s){var tpl=s.tpl||"",data=s.data||{},cb=s.cb||function(str){};this.get_tpl(tpl,function(tplstr){cb(ejs.render(tplstr,data))})},get_tpl:function(path,cb){var str=tpl.search_cache(path);str?cb(str):$.get({url:path,success:function(data){tpl.tpl_cache.push({path:path,data:data}),cb(data)}})},search_cache:function(path){var data=!1;for(var i in tpl.tpl_cache){tpl.tpl_cache[i].path==path&&(data=tpl.tpl_cache[i].data);break}return data||!1},tpl_cache:[]};a.blog=function(){var my={listPage:function(){a.s.loader.fs.create(),$.ajax({type:"GET",url:"./api/blog/list/",data:{},dataType:"json",cache:!1,success:function(result){result.success?tpl.run({tpl:"./tpl/blog/list.ejs",data:result,cb:function(content){$("#body").empty().append(content),setTimeout(function(){$('#body button[data-action="create"]').unbind().click(function(){my.createPost()})},100)}}):alert("Error loading posts from API")}}).done(function(){a.s.loader.fs.remove()})},createPost:function(){var title=prompt("Blog post title:","");null!=title&&0<title.length&&(a.s.loader.fs.create(),$.ajax({type:"POST",url:"./api/blog/create/",data:{title:title},dataType:"json",cache:!1,success:function(result){result.success&&result.id?location.hash="#/blog/edit/"+result.id+"/":alert("Error creating blog post")}}).done(function(){a.s.loader.fs.remove()}))},editPage:function(id){a.s.loader.fs.create(),$.ajax({type:"GET",url:"./api/blog/load/",data:{id:id},dataType:"json",cache:!1,success:function(result){result.success&&result.data?tpl.run({tpl:"./tpl/blog/edit.ejs",data:result,cb:function(content){$("#body").empty().append(content),setTimeout(function(){my.initEditor(),$('button[data-action="select-main-image"]').unbind("click").click(function(){my.filePicker.create(function(){},!0,!1)}),$('button[data-action="save"]').unbind("click").click(function(){my.saveBlog()})},100)}}):location.hash="/blog/list/"}}).done(function(){a.s.loader.fs.remove()})},saveBlog:function(){a.s.loader.fs.create(),tinyMCE.triggerSave(),setTimeout(function(){$.ajax({type:"POST",url:"./api/blog/save/",data:$('form[name="edit_post"]').serialize(),dataType:"json",cache:!1,success:function(result){result.success?a.s.growl.create("Success","The changes was saved.",{}):a.s.growl.create("Error","Unable to save changes. Reload and try again.",{})}}).done(function(){a.s.loader.fs.remove()})},100)},initEditor:function(){tinymce.init({selector:"textarea.tinymce",height:500,plugins:"preview searchreplace autolink directionality visualblocks visualchars fullscreen image link media template codesample table charmap hr pagebreak nonbreaking anchor toc insertdatetime advlist lists wordcount imagetools textpattern help code",toolbar1:"formatselect | bold italic strikethrough forecolor backcolor | link image | alignleft aligncenter alignright alignjustify  | numlist bullist outdent indent  | removeformat | fullscreen code",image_advtab:!0,image_dimensions:!1,relative_urls:!1,content_css:[],image_title:!0,file_picker_types:"image file media",file_picker_callback:function(cb,value,meta){my.filePicker.create(cb,!0,!1)}})},filePicker:{create:function(cb,fullpath,filename_only){a.s.popup.create({title:"Select image",width:900,height:500})}}};return my}(),a.router.init();